- name: Configure fabric
  gather_facts: no
  hosts:
    - leaf
    - spine
  vars:
    purge: yes # purge resources from device not in intent
    purgeable:
      - interface
      - subinterface
      - network-instance
      - tunnel-interface
  roles:
    ## INIT - Set device facts
    - role: common/init
      tags: [always]
    ## INFRA - Load infrastructure-related intent
    - role: infra
      tags: [ infra]
    ## SERVICES - Load/generate service-related intent
    - role: services        # Loads l2vpn and l3vpn intents from ./intent dir
      tags: [services] 
    - role: services/l2vpn  # Generates low-level intent from 'l2vpn' intent
      vars:
        l2vpn: l2vpn        # make input explicit, 'l2vpn' is generated by role 'services' (redundant)
      tags: [services, l2vpn] 
    - role: services/l3vpn  # Generate low-level intent from 'l3vpn' intent
      vars:
        l3vpn: l3vpn        # make input explicit, 'l3vpn' is generated by role 'services' (redundant)
      tags: [services, l3vpn]
    ## CONFIG PUSH - Generate low-level JSON-RPC data from intent and set device config
    - role: common/configure
      tags: [always]
