- name: Configure fabric
  gather_facts: false
  hosts:
    - leaf
    - spine
    - borderleaf
    - superspine
    - dcgw
  roles:
    ## INIT -m Set device facts
    - role: initialize
      tags: [always]
    ## INFRA - Load infrastructure-related intent
    - role: fabric
      vars:
        intent_dir: "intent"
      tags:
        - infra
    - role: infra
      vars:
        intent_dir: "intent"
      tags: [infra]
    ## SERVICES - Load/generate service-related intent
    - role: services          # Loads l2vpn and l3vpn intents from ./intent dir
      vars:
        intent_dir: "intent"  # relative to 'plat'
      tags: [services]
    - role: mh_access         # Generates low-level intent from 'mh_access' intent
      vars:
        mh_access: mh_access  # make input explicit, 'l2vpn' is generated by role 'services' (redundant)
      tags: [services, mh_access]
    - role: l2vpn             # Generates low-level intent from 'l2vpn' intent
      vars:
        l2vpn: l2vpn          # make input explicit, 'l2vpn' is generated by role 'services' (redundant)
      tags: [services, l2vpn]
    - role: l3vpn             # Generate low-level intent from 'l3vpn' intent
      vars:
        l3vpn: l3vpn          # make input explicit, 'l3vpn' is generated by role 'services' (redundant)
      tags: [services, l3vpn]
    ## CONFIG PUSH - Generate low-level JSON-RPC data from low-level intent and set device config
    - role: configure
      vars:
        intent: intent        # generated low-level intent from previous roles (explicit > implicit vars)
        purge: true           # purge resources from device not in intent
        save_startup: false    # save config to startup-config, override with --extra-vars "save_startup=true" to ansible-playbook
        purgeable:
          - interface
          - subinterface
          - network-instance
          - tunnel-interface
      tags: [always]
