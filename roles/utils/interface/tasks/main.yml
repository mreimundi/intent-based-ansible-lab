- name: Check available template versions
  stat:
    path: "{{ role_path + '/templates/' + platform + '/' + item }}"
  register: dirs
  loop:
    - "{{ sw_version }}"
    - "{{ sw_version|regex_replace('(\\.\\d+$)', '') }}"
    - "{{ sw_version|regex_replace('(\\.\\d+\\.\\d+$)', '') }}"
    - "default"


- name: Set template version
  set_fact: 
    tpl_base: "{{ dirs.results[3].stat | combine(dirs.results[2].stat, dirs.results[1].stat, dirs.results[0].stat) }}"
  failed_when: not tpl_base.isdir

- name: Generate config for /interface
  set_fact:
    update: "{{ update + lookup('template', template_file, template_vars=intent) | from_yaml }}"
    cacheable: true
  when: intent.interfaces is defined and intent.interfaces is not none
  vars:
    template_file: "{{ tpl_base.path + '/interface.j2' }}"

- name: Generate config for /interface/subinterface
  set_fact:
    replace: "{{ replace + lookup('template', template_file, template_vars=intent) | from_yaml | default([], true) }}"
    cacheable: true
  when: intent.subinterface is defined and intent.subinterface is not none
  vars:
    template_file: "{{ tpl_base.path + '/subinterface.j2'}}"

- name: Generate config for /tunnel-interface
  set_fact:
    update: "{{ update + lookup('template', template_file, template_vars=intent) | from_yaml | default([], true) }}"
    cacheable: true
  when: intent.tunnel_interface is defined and intent.tunnel_interface is not none
  vars:
    template_file: "{{ tpl_base.path + '/tunnel.j2'}}"
